{% extends "base.html" %}
{% block content %}
<section class="family-container">
  {% if not user.family_id %}
    <div class="no-family">
      <h2>–í—ã –µ—â—ë –Ω–µ –≤ —Å–µ–º—å–µ</h2>
      <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Å–µ–º—å—é –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π</p>
      <div class="family-actions">
        <a href="{{ url_for('create_family') }}" class="btn">–°–æ–∑–¥–∞—Ç—å —Å–µ–º—å—é</a>
        <a href="{{ url_for('join_family') }}" class="btn btn-outline">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</a>
      </div>
    </div>
  {% else %}
    <div class="family-banner">
      <h1>–°–µ–º—å—è: {{ family.name }}</h1>
      <label for="leave-family-modal" class="leave-family-btn">–í—ã–π—Ç–∏ –∏–∑ —Å–µ–º—å–∏</label>
    </div>

    <!-- –ß–µ–∫–±–æ–∫—Å –∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <input type="checkbox" id="leave-family-modal" class="modal-toggle">

    <div class="modal">
      <div class="modal-content">
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —Å–µ–º—å–∏?<br>–í—Å–µ –±–∞–ª–ª—ã –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã.</p>
        <div class="modal-actions">
          <form method="POST" action="{{ url_for('leave_family') }}">
            <button type="submit" class="btn btn-danger">–î–∞, –≤—ã–π—Ç–∏</button>
          </form>
          <label for="leave-family-modal" class="btn btn-cancel">–û—Ç–º–µ–Ω–∞</label>
        </div>
      </div>
    </div>


    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–º—å–∏ -->
    <div class="stats-grid">
      <div class="stat-card stat-primary">
        <div class="stat-progress" style="--value: {{ (statistics.week / 1000 * 100) }}%"></div>
        <p>–ë–∞–ª–ª—ã –∑–∞ –Ω–µ–¥–µ–ª—é</p>
        <strong>{{ statistics.week }}</strong>
      </div>
      <div class="stat-card stat-secondary">
        <div class="stat-progress" style="--value: {{ (statistics.month / 5000 * 100) }}%"></div>
        <p>–ë–∞–ª–ª—ã –∑–∞ –º–µ—Å—è—Ü</p>
        <strong>{{ statistics.month  }}</strong>
      </div>
      <div class="stat-card stat-accent">
        <div class="stat-progress" style="--value: {{  (statistics.all_time / 20000 * 100) }}%"></div>
        <p>–í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤</p>
        <strong>{{ statistics.all_time }}</strong>
      </div>
    </div>

    <!-- –ß–ª–µ–Ω—ã —Å–µ–º—å–∏ -->
    <div class="family-members">
      <h2 class="section-title">–ß–ª–µ–Ω—ã —Å–µ–º—å–∏ <span>{{ lst_users|length }}</span></h2>
      <div class="members-grid">
        {% for member in lst_users %}
        <div class="member-card" style="animation-delay: {{ loop.index * 0.1 }}s">
          <div class="member-avatar">
            <img src="{{ url_for('userava', user_id=member.id) }}" alt="{{ member.first_name }}" class="member-photo"/>
            <div class="member-rank">{{ loop.index }}</div>
          </div>
          <h3>{{ member.first_name }} {{ member.last_name }}</h3>
          <div class="member-stats">
            <div class="stat-item">
              <span>–ë–∞–ª–ª—ã –∑–∞ –Ω–µ–¥–µ–ª—é</span>
              <strong>{{ score(member.id,periods="week").all_time }}</strong>
            </div>
            <div class="stat-item">
              <span>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
              <strong>{%if not streak(member.id)[1]%}üî•{%else%}‚ùÑÔ∏è{%endif%}{{streak(member.id)[0]  |default('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö') }}</strong>
            </div>
          </div>
          <div class="top-tasks1">
            <h4>–¢–æ–ø –∑–∞–¥–∞—á –∑–∞ –Ω–µ–¥–µ–ª—é</h4>
            <ul>
              {% for task in best_result_for_week(member.id,period='week') %}
              <li>
                <span class="task-name">{{ task.name }}</span>
                <span class="task-count">{{ task.quantity }} —Ä–∞–∑</span>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="activity-feed">
      <h2 class="section-title">–õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
      <ul class="timeline">
        {% for task in family_tasks[:10] %}
        <li class="timeline-item">
          <div class="timeline-badge"></div>
          <div class="timeline-content">
            <span class="user">{{ task.first_name }}</span>
            <span class="action">–≤—ã–ø–æ–ª–Ω–∏–ª(–∞)</span>
            <strong class="task">{{ task.name }}</strong>
            <span class="points">+{{ task.custom_points }} –±–∞–ª–ª–æ–≤</span>
            <time class="time">{{ format_task_date(task.date)}}</time>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</section>
{% endblock %}